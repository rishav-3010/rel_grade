<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Relative Grading System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f5f5f5;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
    }
    .user-row {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .submitted {
      color: green;
      font-weight: bold;
    }
    .result {
      margin-top: 1.5rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .current-user {
      background: #e8f4f8;
      border: 2px solid #4CAF50;
    }
  </style>
</head>
<body>

  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <div id="g_id_onload"
       data-client_id="181147286587-j7618kih9l4ntnfpafh38d92q4gfp2ic.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-theme="outline"
       data-size="large"></div>

  <h1>Relative Grading System</h1>

  <div id="userList"></div>
  <div class="result" id="output" style="display:none;"></div>

  <script>
    let currentEmail = null;
    let currentName = null;

    // Dynamic API URL detection
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://rel-grade.onrender.com';

    console.log('Using API Base URL:', API_BASE_URL);

    // List of all allowed emails (same as server)
    const allowedEmails = [
      "rishav.vajpayee2022@vitstudent.ac.in",
      "vajpayeerishav79@gmail.com",
      "vajpayeerishav@gmail.com",
      "vajpayeeyukta06@gmail.com",
      "debasisbajpaie@gmail.com"
    ];

    function handleCredentialResponse(response) {
      console.log('Attempting authentication...');
      fetch(`${API_BASE_URL}/api/auth/google`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: response.credential })
      })
      .then(res => {
        console.log('Auth response status:', res.status);
        return res.json();
      })
      .then(data => {
        console.log('Auth response data:', data);
        if (data.success) {
          currentEmail = data.email;
          currentName = data.name;
          alert(`Welcome, ${data.name} (${data.email})`);
          loadUserList();
        } else {
          alert("Access denied. Not a registered VIT email.");
        }
      })
      .catch(err => {
        console.error('Auth error:', err);
        alert("Authentication failed. Please try again.");
      });
    }

    async function loadUserList() {
      console.log('Loading user list...');
      try {
        const url = `${API_BASE_URL}/get-users`;
        console.log('Fetching from:', url);
        const res = await fetch(url);
        console.log('Response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const existingUsers = await res.json();
        console.log('Existing users:', existingUsers);
        
        const container = document.getElementById("userList");
        container.innerHTML = "";

        // Create a map of existing users for quick lookup
        const userMap = {};
        existingUsers.forEach(user => {
          userMap[user.email] = user;
        });

        console.log('Current user email:', currentEmail);
        console.log('Allowed emails:', allowedEmails);
        
        // Show all allowed emails
        allowedEmails.forEach(email => {
          const row = document.createElement("div");
          row.className = "user-row";
          
          const existingUser = userMap[email];
          const isCurrentUser = (email === currentEmail);
          
          if (isCurrentUser) {
            row.classList.add("current-user");
          }

          if (isCurrentUser) {
            // Current user - show input or submitted status
            if (existingUser && existingUser.submitted) {
              row.innerHTML = `
                <b>${existingUser.name || email}</b> (You) - 
                <span class="submitted">Mark: ${existingUser.mark} - Already submitted</span>
              `;
            } else {
              row.innerHTML = `
                <b>${currentName || email}</b> (You) - 
                <input type="number" id="markInput" min="0" max="100" placeholder="Enter mark (0-100)" step="0.01">
                <button onclick="submitMark()">Submit Mark</button>
              `;
            }
          } else {
            // Other users
            if (existingUser && existingUser.submitted) {
              row.innerHTML = `
                <b>${existingUser.name || email}</b> - 
                <span class="submitted">Submitted</span>
              `;
            } else {
              row.innerHTML = `
                <b>${email}</b> - 
                <span style="color: #666;">Not Submitted</span>
              `;
            }
          }

          container.appendChild(row);
        });

        // Show grade calculation if there are submitted marks
        if (existingUsers.some(user => user.submitted)) {
          await updateGradeDisplay();
        }

      } catch (err) {
        console.error('Detailed error loading user list:', err);
        console.error('Error message:', err.message);
        alert(`Error loading user list: ${err.message}. Please check console and refresh the page.`);
      }
    }

    async function submitMark() {
      const markInput = document.getElementById("markInput");
      const value = parseFloat(markInput.value);

      if (isNaN(value) || value < 0 || value > 100) {
        alert("Please enter a valid mark between 0 and 100.");
        return;
      }

      if (!currentEmail || !currentName) {
        alert("Please sign in first.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/submit-mark`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name: currentName, 
            email: currentEmail, 
            value: value 
          })
        });

        if (res.status === 403) {
          const msg = await res.text();
          alert(msg);
          return;
        }

        if (res.ok) {
          alert("Mark submitted successfully!");
          await loadUserList();
        } else {
          alert("Error submitting mark. Please try again.");
        }

      } catch (err) {
        console.error('Submit error:', err);
        alert("Network error. Please check your connection and try again.");
      }
    }

    async function updateGradeDisplay() {
      try {
        const gradesRes = await fetch(`${API_BASE_URL}/calculate-grades`);
        
        if (!gradesRes.ok) {
          return; // No grades to display yet
        }

        const data = await gradesRes.json();

        const out = document.getElementById("output");
        out.innerHTML = `
        <h3>Grade Bands (from ${data.count} submitted marks)</h3>
        <p>Mean: <b>${data.mean}</b></p>
        <p>Standard Deviation: <b>${data.stdDev}</b></p>
        <p>Pass Mark: <b>${data.passMark}</b></p>
        <ul>
          <li><b>S Grade</b>: ${data.S}</li>
          <li><b>A Grade</b>: ${data.A}</li>
          <li><b>B Grade</b>: ${data.B}</li>
          <li><b>C Grade</b>: ${data.C}</li>
          <li><b>D Grade</b>: ${data.D}</li>
          <li><b>E Grade</b>: ${data.E}</li>
          <li><b>F Grade</b>: ${data.F}</li>
        </ul>
        `;
        out.style.display = "block";
      } catch (err) {
        console.error('Error updating grades:', err);
      }
    }

    // Initialize on page load
    window.onload = () => {
      console.log("Page loaded. Please sign in to continue.");
      console.log("API Base URL:", API_BASE_URL);
    };
  </script>
</body>
</html>